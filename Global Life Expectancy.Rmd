---
title: ""
---

####Life Expectancy, then and now

As an amateur statistician, I'm a big fan of the late Hans R&ouml;sling and by extension: [GapMinder](https://www.gapminder.org/). If you're not familiar with their work: they aim to update how we view the world through the visual communication of statistics.  For instance, check out this great little tidbit from a [BBC show](https://www.youtube.com/watch?v=jbkSRLYSojo). As it turns out, much of what we think we know about the world is outdated and no longer reflects the current state of affairs. As it also turns out: by alot of metrics, our world has improved tremendously. Most of their stats send a positive and hopeful message. The big picture message is that our world has improved tremendously, even if it doesn't always feel that way. 

I also enjoy messing around with new R packages and data visualization. A while ago, I stumbled upon the [rMaps](http://rmaps.github.io/ pacakge). Although, it seems that the package hasn't been updated in a while, it still provides some very interesting functionality that could be used to visualize some of the amazing data provided by Gapminder. More specifcally, it can be used to create animated world maps. As an homage to Gapminder and Hans  R&ouml;sling, I figured it could be interesting to animate changes to life expectancy on a global world map from 1850 up until now.

the rMaps package is not (yet?) available through CRAN but it can be easily downloaded through github and thus through the "devtools" package. The "devtools" package is typically the easiest way to download packages that are still in development on github. All you need is the url where you can find the package and "devtools" does all the hard work:

```{r, message=FALSE, warning=FALSE}
library(devtools)
install_github('ramnathv/rCharts@dev')
install_github('ramnathv/rMaps')

library(rCharts)
library(rMaps)
library(knitr)
```

Gapminder also provides the data they use for their analyses freely on their website. You can download it in a number of ways. One of the ways i which they provide their data is through googledocs. Ancient R-wisdom dictates that yes, "there is an R package for that". In this case, the apptly named "googlesheets" package can come to our rescue. We will also need sile "dplyr" magic. Additionally, we're going to need the "reshape2" package later on, so we might as well just load it immediately.


```{r, message=FALSE, warning=FALSE}
library(googlesheets)
library(plyr)
library(dplyr)
library(rCharts)
library(reshape2)
library(countrycode)
```


The googlesheets package allows us to extract data from googlesheets through the "key" that is associated with each document. In this case, we want to extract Gapminder's life expectancy data which we can find in this [sheet](https://docs.google.com/spreadsheets/d/1B89xX-0BdNR-qjM7_s5tZi2WCCmobejXd4RaMFKxAIw/). The key we need is just right there in the url. it's the weird mess of numbers and letters after the /d/. We just plug it into into the googlesheets "gs_key"" function. We can also chain the "gs_key"" with the "gs_read"" function to extract the data we need like so:

```{r, message=FALSE, warning=FALSE, results='hide'}
#Grabbing the data from gapminder
life_exp <- gs_key("1B89xX-0BdNR-qjM7_s5tZi2WCCmobejXd4RaMFKxAIw", lookup = FALSE,  verbose=FALSE) %>% 
            gs_read(ws = "Data", check.names=FALSE)
```

A quick glance at this data will teach us that Gapminder has managed to find life expectancy data from the year 1765 and upwards for at least a few countries, but frankly speaking: the data is really sparse at that timepoint. Changes to life expectancy also really only start to happen from 1900 onwards. As such, we subset the data. We're going to start at  1850 but I freely admit that is just a randomly chosen timepoint. However, I do think it is impressive to see how stable life expectancy is from 1850 tp 1900 and how quickly it starts changing from then on. 

While we're at it, the data we have extracted is in [wide format](http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/) and the rMaps package needs the data to be in long format. The reshape2 package allows us to easily "melt"" our data by specifying which variable groups the individual measurements. 

```{r, message=FALSE, warning=FALSE, results='hide'}
#Subsetting the data to start from 1850
life_exp <-life_exp[,c(1,87:252)]
life_exp <- na.omit(life_exp)

#Renaming the country-ID variable to something that makes actual sense
colnames(life_exp)[1] <-"Country"

#Melting the data into a long format
life_exp_long <- melt(life_exp, id.var = "Country")

#Associating ISO3 codes with each country
life_exp_long$Code <- NA
life_exp_long$Code <- countrycode(life_exp_long$Country, 'country.name', 'iso3c')
life_exp_long$Code[life_exp_long$Country == "Central African Rep."] <-  "CAF"

```

We are aiming to create a map of the entire world in which each country is color coded according to its life expectancy for a given year. This is a categorical way of displaying our data and thus we need to categorize the life expectancy data into discrete chunks. The rMaps package could take care of that, but it might be better if we do it ourselves so we could split the data into intuitive categories and clearly label each of those categories. We're also going to associate a color with each of these categories through the "RColorbrewer"" package. It was loaded automatically when we loaded rMaps, so we don't need to explicitly load it again.

```{r, message=FALSE, warning=FALSE, results='hide'}
#Categorizing the data
life_exp_long$fillKey <- NA
life_exp_long$fillKey[life_exp_long$value<80] <- ">70"
life_exp_long$fillKey[life_exp_long$value<70] <- "60 to 70"
life_exp_long$fillKey[life_exp_long$value<60] <- "50 to 60"
life_exp_long$fillKey[life_exp_long$value<50] <- "40 to 50"
life_exp_long$fillKey[life_exp_long$value<40] <- "30 to 40"
life_exp_long$fillKey[life_exp_long$value<30] <- "20 to 30"
life_exp_long$fillKey[life_exp_long$value<20] <- "<20"

fills = setNames(
  c(RColorBrewer::brewer.pal(7, 'RdYlGn'), 'white'),
  c(c("<20","20 to 30","30 to 40","40 to 50","50 to 60","60 to 70",">70"), 'defaultFill')
  )
```

The documentation for rMaps is somewhat sparse. There are some blog posts available that walk you through an example but the package does not yet have the regular documentation that you can access from R. The easiest way to create our map would be to use the "ichoropleth" function, but I'd like to have a bit more control over the end-result. This can quite easily be achieved by using some javascript. I don't actually know much javascript. In fact, I don't really know any javascript at all, but it's easy to tweak the code that is provided on the rMaps blogs. The next bit of code does the following things: first we use "plyr" to turn our dataframe into a list, which is what we feed to "Datamaps", the javascript framework creating the worldmap in the background. We then make a first, static map, animate it in a second step and add a play button in the third and final step. This code might look daunting but you only need to change a few things around to get it to work. 

```{r, message=FALSE, warning=FALSE}
#Turning the data into a list
dat <- dlply(life_exp_long, "variable", function(x){
  y = toJSONArray2(x, json = F)
  names(y) = lapply(y, '[[', 'Code')
  return(y)})

#Creating First Choropleth
options(rcharts.cdn = TRUE)
map <- Datamaps$new()
map$set(
  dom = 'chart_1',
  scope = 'world',
  fills = fills,
  data = dat[[1]],
  legend = TRUE,
  labels = FALSE)

#Animated chloropleth
map2 = map$copy()
map2$set(
  bodyattrs = "ng-app ng-controller='rChartsCtrl'")

map2$addAssets(
  jshead = "http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js")

map2$setTemplate(chartDiv = "
  <div id = 'chart_1' class = 'rChart datamaps'>
  <input id='slider' type='range' min=1850 max=2015 ng-model='year' width=200>
  <span ng-bind='year'></span>
    
  <script>
    function rChartsCtrl($scope){
      $scope.year = '1850';
      $scope.$watch('year', function(newYear){
        mapchart_1.updateChoropleth(chartParams.newData[newYear]);
      })
    }
  </script>
  </div>")
map2$set(newData = dat)

#Add the play button
map3 = map2$copy()
map3$setTemplate(chartDiv = "
                 <div class='container'>
                 <button ng-click='animateMap()'>Play</button>
                 <div id='chart_1' class='rChart datamaps'></div>  
                 </div>
                 <script>
                 function rChartsCtrl($scope, $timeout){
                   $scope.year = 1850;
                   $scope.animateMap = function(){
                     if ($scope.year > 2014){
                       return;
                      }
                   mapchart_1.updateChoropleth(chartParams.newData[$scope.year]);
                   $scope.year += 1
                   $timeout($scope.animateMap, 100)
                   }
                 }
                 </script>")
map3
```



